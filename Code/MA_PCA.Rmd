---
title: "PCA components"
output: html_document
---

```{r,message=F, echo=F, eval=T,warning=F,results="hide"}
if (!require("matrixStats"))
{
  install.packages("matrixStats")
  library(matrixStats)
}
load("c:/TFM/Data/BDistrophyD.rda")
load("c:/TFM/Data/HealthyD.rda")
```

#INTRODUCTION#
Along this document, we are going to achieve a better knowledge about the first principal components. We will start explaining the method used with BMDistrophy data and we will apply the same procedures for the Healthy data.

#PROCEDURE#

The main idea of this document is to understand which is the relationship between each initial variable and the first principal components. In order to do this, we will reconstruct the initial database (scaled) from PCA outputs and vice versa: construct first PC components with eigenvectors and variable values (from the initial database).

With the purpose of reconstructing the initial scaled database from PCA outputs, we have followed the steps:

1) Compute PCA with prcomp function


```{r}
#Timestamp and data type are not relevant variables for PCA
x<-as.matrix(subset(BMD,select=-c(Timestamp,Type)))
#Performing PCA
pca<-prcomp(x,center=T,scale=T)
```

2) Save the relevant results: 

2.1. eigenvectors: relation between PCs and database variables

2.2. $\mu$: database constructed with the variable means

2.3. indiv_components: value of PCs for each individual (in our data, individual=timestamp mark)

```{r}
eigenvectors<-as.matrix(pca$rotation) #PCs as columns, Initial variables as rows
mu<-unname(pca$center)
mu<-matrix(mu,nrow=nrow(x),ncol=ncol(x),byrow=TRUE)
sigma<-unname(apply(BMD[,2:18], 2, sd, na.rm = TRUE))
sigma<-matrix(sigma,nrow=nrow(x),ncol=ncol(x),byrow=TRUE)
indiv_components<-as.matrix(pca$x) #PCs as columns, Individuals as rows
```

3. In order to reconstruct the initial values, we should follow the formula:
$$
Var=PC_{scores}Eigenvectors
$$
```{r}
res<-indiv_components[,1]%*%t(eigenvectors)
```

4. The 3rd step would rebuild the initial database if we had not centered nor scaled the initial database.

In order to 'correct' the center and scale steps, we must do the product by the variance and then add the $\mu$ matrix:

```{r}
res<-(res*sigma)+mu
```

5. Check: The previous database is the initial one but scaled, we can check the first 5 variables:

```{r}
head(res[,1:5])
head(x[,1:5])
```

We can observe the same results on the initial scaled database and on the computed one.

With the purpose of reconstructing the PC with the eigenvectors and initial database, we should perform the previous 1 and 2 steps and then:

3. For the first principal component, we should multiply the scale values of the initial database by the first column of eigenvectors:

```{r}
#Reconstructing first PCA component:
pc1<-scale(x)%*%eigenvectors[,1]
```

4. Checking:
```{r}
head(pc1)
head(indiv_components[,1])
```

We can observe the same results on the R output and on the computed one.

#BMDISTROPHY DATA#

Now, we are going to reconstruct the initial data base but using only one PC per reconstruction. We will perform de reconstruction with first 6 components that explain more than a 80% of the variability of the original dataset:

```{r}
res<-indiv_components[,1]%*%t(eigenvectors[,1])
```

<video width="320" height="240" controls>
  <source src="c:/TFM/Results/HT_347355_455355_1200.mp4" type="video/mp4">
</video>

